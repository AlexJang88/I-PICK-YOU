<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>

<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Title</title>
    <style>
        .chat-window {
            position: fixed;
            top: 0;
            right: 0;
            width: 25%;
            height: 100%;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: #f9f9f9;
            z-index: 9999; /* Ensure it's above other elements */
        }
        .chat-header {
            background-color: #f1f1f1;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            text-align: center;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .chat-body {
            height: calc(100% - 40px); /* Adjust height for header and footer */
            padding: 10px;
            overflow-y: scroll;
            border-bottom: 1px solid #ccc;
        }
        .chat-footer {
            padding: 10px;
            border-top: 1px solid #ccc;
            text-align: center;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f1f1f1;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        #input_box {
            width: calc(100% - 70px); /* Adjust width for send button */
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #sendmsg {
            margin-left: 10px;
            padding: 5px 10px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>


<body>
<div th:fragment="navi">


    <nav class="layout-navbar container-fluid navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
         id="layout-navbar">
        <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
                <i class="bx bx-menu bx-sm"></i>
            </a>
        </div>

        <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <ul class="navbar-nav flex-row align-items-center ms-auto">
                <!-- Place this tag where you want the button to render. -->
                <table id="weatherTable">

                </table>

                <!--알림버튼-->

                    <button type="button" class="btn btn-icon btn-secondary position-relative" sec:authorize="hasRole('ROLE_USER')">
                        <a th:href="@{/alarm/list/{id}(id=${#authentication.name})}">
                        <span class="tf-icons bx bx-bell"></span>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                              <span id="alertCounter">0</span> <!-- 알림 카운터를 표시할 요소 -->
                            <span class="visually-hidden">unread messages</span>
                        </span>
                        </a>
                    </button>
                <button type="button" class="btn btn-icon btn-secondary position-relative" sec:authorize="hasRole('ROLE_COMPANY')">
                    <a th:href="@{/alarm/list/{id}(id=${#authentication.name})}">
                        <span class="tf-icons bx bx-bell"></span>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                          <span id="alertCounter">0</span> <!-- 알림 카운터를 표시할 요소 -->
                            <span class="visually-hidden">unread messages</span>
                        </span>
                    </a>
                </button>
                <button type="button" class="btn btn-icon btn-secondary position-relative" sec:authorize="hasRole('ROLE_ADMIN')">
                    <a th:href="@{/alarm/adminlist/{id}(id=${#authentication.name})}">
                        <span class="tf-icons bx bx-bell"></span>
                    </a>
                </button>
                <span> </span>
                <span> </span>
                <span> </span>

                <!-- User -->
                <li class="nav-item navbar-dropdown dropdown-user dropdown">

                    <!--프로필이미지 불러오는곳-->
                    <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                        <div class="d-flex align-items-center">
                            <div class="demo-inline-spacing" sec:authorize="!isAuthenticated()">
                                <button type="button" class="btn btn-primary">로그인</button>
                            </div>
                            <div sec:authorize="isAuthenticated()">
                                <img th:src="@{/assets/img/avatars/3.png}" alt="" class="w-px-40 h-auto rounded-circle" />
                            </div>
                            <div sec:authorize="isAuthenticated()">
                                <p class="mb-0 ms-2" th:text="${#authentication.name}"></p>
                            </div>
                        </div>
                    </a>


                    <!--프로필 눌렀을때-->
                    <ul  class="dropdown-menu dropdown-menu-end">
                        <!--사람 이름과 하위메뉴-->
                        <li>
                            <a sec:authorize class="dropdown-item" href="#">


                                    <div class="d-flex">
                                        <div class="flex-shrink-0 me-3">
                                            <div>

                                                <img sec:authorize="isAuthenticated()" th:src="@{/assets/img/avatars/1.png}" alt=""
                                                     class="w-px-40 h-auto rounded-circle" />

                                            </div>
                                        </div>

                                        <div class="flex-grow-1">

                                            <span  sec:authorize="isAuthenticated()" class="fw-semibold d-block">John Doe</span>
                                                <small sec:authorize="isAuthenticated()" class="text-muted">회원님</small>
                                        </div>
                                    </div>
                            </a>
                        </li>


                        <li>
                            <div  sec:authorize="isAuthenticated()" class="dropdown-divider"></div>
                        </li>
                        <li sec:authorize="hasRole('ROLE_USER')">
                            <a class="dropdown-item" th:href="@{/mypage/information/{id}(id=${#authentication.name})}">
                                <i class="bx bx-user me-2"></i>
                                <span class="align-middle">마이페이지</span>
                            </a>
                        </li>
                        <li sec:authorize="hasRole('ROLE_COMPANY')">
                            <a class="dropdown-item" th:href="@{/mypage/cominformation/{id}(id=${#authentication.name})}">
                                <i class="bx bx-user me-2"></i>
                                <span class="align-middle">마이페이지</span>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="bx bx-cog me-2"></i>
                                <span class="align-middle">문의하기</span>
                            </a>
                        </li>
                        <li sec:authorize="!isAuthenticated()">
                            <a class="dropdown-item" href="/login">
                                <span class="d-flex align-items-center align-middle">
                                    <i class="flex-shrink-0 bx bx-credit-card me-2"></i>
                                    <span class="flex-grow-1 align-middle">회원가입하기</span>
                                </span>
                            </a>
                        </li>
                        <li>
                            <div  sec:authorize="isAuthenticated()" class="dropdown-divider"></div>
                        </li>

                        <li sec:authorize="!isAuthenticated()">
                            <a  class="dropdown-item" th:href="@{/login}">
                                <i class="bx bx-power-off me-2"></i>
                                <span  class="align-middle">Log in</span>
                            </a>
                        </li>


                        <li sec:authorize="isAuthenticated()">
                            <a  class="dropdown-item" th:href="@{/logout}">
                                <i class="bx bx-power-off me-2"></i>
                                <span  class="align-middle">Log Out</span>
                            </a>
                        </li>

                    </ul>
                </li>
                <!--/ User -->
            </ul>
        </div>
        <input type="hidden" id="ajaxId" th:value="${id}"> <!-- 실제 사용자 ID를 여기에 설정 -->
        <script th:inline="javascript">
            $(document).ready(function(){
          $('#openChatBtn').click(function() {
            var user = $('#user').text().trim();
            var chatUrl = 'http://localhost:4000/chat/' + sender + '/' + receiver;

            $('#chatFrame').attr('src', chatUrl);
            $('#myModal').modal('show');
            });
            $('#openChatRoomBtn').click(function() {
            var sender = $('#sender').val();
            var receiver = $('#receiver').val();
            var chatUrl = 'http://localhost:4000/rooms/' + sender

            $('#chatFrame').attr('src', chatUrl);
            $('#myModal').modal('show');
        });
              
              function fetchAlarmCount() {
                    console.log("ajax작동");

                    var id = $("#ajaxId").val();  // hidden input 태그에서 id 값을 가져옴

                    console.log("id:", id);

                    // AJAX 요청 보내기
                    $.ajax({
                        url: '/ajax/alarmnumber/number',
                        type: "POST",
                        contentType: 'application/json',
                        data: JSON.stringify({ id: id }),
                        dataType: "json",
                        success: function(data) {
                            console.log("AJAX 성공:", data);
                            $("#alertCounter").text(data.alarmcount); // 서버에서 받은 데이터로 알림 카운터 업데이트
                        },
                        error: function(xhr, status, error) {
                            console.error("AJAX 에러:", error);
                            console.log("xhr:", xhr);
                            console.log("status:", status);
                            console.log("error:", error);
                        }
                    });
                }

                // 페이지 로드 후 1분마다 fetchAlarmCount 함수 실행
                fetchAlarmCount(); // 초기 실행
                setInterval(fetchAlarmCount, 60000); // 1분(60000밀리초)마다 실행
            });
        </script>
        <script>
            const cities = [
                { engName: 'Seoul', korName: '서울' },
                { engName: 'Busan', korName: '부산' },
                { engName: 'Daegu', korName: '대구' },
                { engName: 'Incheon', korName: '인천' },
                { engName: 'Gwangju', korName: '광주' },
                { engName: 'Daejeon', korName: '대전' },
                { engName: 'Ulsan', korName: '울산' }
            ];
            let currentIndex = 0;

            // API 요청 및 데이터 표시 함수
            function fetchWeather(cityId, cityName) {
                fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cityId}&appid=99612c2cd2cf86724058d9b5b6cba6d5&units=metric`)
                    .then(response => response.json())
                    .then(data => {
                        const temperature = data.main.temp;
                        const humidity = data.main.humidity;
                        const weatherIcon = data.weather[0].icon;

                        // 특정 도시의 행을 업데이트
                        const existingRow = document.getElementById('currentRow');
                        if (existingRow) {
                            existingRow.innerHTML = `
                                <td>${cityName}</td>
                                <td>${temperature} ℃</td>

                                <td><img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${data.weather[0].description}"></td>
                            `;
                        } else {
                            // 새로운 행 추가
                            const weatherTable = document.getElementById('weatherTable');
                            const newRow = weatherTable.insertRow();
                            newRow.id = 'currentRow';
                            newRow.innerHTML = `
                                <td>${cityName}</td>
                                <td>${temperature} ℃</td>

                                <td><img src="https://openweathermap.org/img/wn/${weatherIcon}.png" alt="${data.weather[0].description}"></td>
                            `;
                        }

                        // 다음 도시로 인덱스 이동
                        currentIndex++;
                        if (currentIndex >= cities.length) {
                            currentIndex = 0; // 모든 도시를 표시한 후 다시 처음부터 시작
                        }

                        // 다음 도시의 날씨 정보 요청
                        setTimeout(() => fetchWeather(cities[currentIndex].engName, cities[currentIndex].korName), 5000);
                    })
                    .catch(error => console.error(`API 요청 중 에러 발생 (${cityName}):`, error));
            }

            // 초기화: 서울 날씨 정보 요청
            setTimeout(() => fetchWeather('Seoul', '서울'), 0); // 0초 후에 실행
        </script>

    </nav>
</div>
</body>

</html>
