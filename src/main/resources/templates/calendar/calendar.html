<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head >
    <meta charset='utf-8' />
    <title>Calendar with Weather</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <style>
        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }
        .fc-event .weather-icon {
            display: inline-block;
            vertical-align: middle;
        }
        .fc-event .weather-temp {
            display: inline-block;
            vertical-align: middle;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<input type="hidden" id="userId" name="userId" th:value="${memberId}">
<div id='calendar'></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const city = { engName: 'Seoul', korName: '서울' };
        const calendarEl = document.getElementById('calendar');
        const userId = document.getElementById('userId').value; // memberId 가져오기
        let events = [];

        fetchData();

        function initializeFullCalendar(events) {
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: 'dayGridMonth,dayGridWeek,dayGridDay'
                },
                locale: 'ko',
                events: events,
                eventContent: function(arg) {
                    // 사용자 정의 이벤트 콘텐츠 표시
                    let arrayOfDomNodes = [];

                    let titleEl = document.createElement('div');
                    if (arg.event.extendedProps.weatherIcon) {
                        let weatherIconEl = document.createElement('img');
                        weatherIconEl.src = arg.event.extendedProps.weatherIcon;
                        weatherIconEl.className = 'weather-icon';
                        titleEl.appendChild(weatherIconEl);
                    }

                    if (arg.event.extendedProps.weatherTemp) {
                        let weatherTempEl = document.createElement('span');
                        weatherTempEl.innerHTML = ` ${arg.event.extendedProps.weatherTemp}℃`;
                        weatherTempEl.className = 'weather-temp';
                        titleEl.appendChild(weatherTempEl);
                    }

                    let titleTextEl = document.createElement('span');
                    titleTextEl.innerHTML = ` ${arg.event.title}`;
                    titleEl.appendChild(titleTextEl);

                    arrayOfDomNodes.push(titleEl)

                    return { domNodes: arrayOfDomNodes }
                }
            });

            calendar.render();
        }

        function fetchWeather(cityId, cityName) {
            fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${cityId}&appid=99612c2cd2cf86724058d9b5b6cba6d5&units=metric&lang=kr`)
                .then(response => response.json())
                .then(data => {
                    const uniqueDates = new Set();
                    data.list.forEach(forecast => {
                        const date = forecast.dt_txt.split(' ')[0];
                        if (uniqueDates.size < 5 && !uniqueDates.has(date)) {
                            uniqueDates.add(date);
                            const temperature = forecast.main.temp;
                            const weatherIcon = forecast.weather[0].icon;

                            const event = {
                                title: '',
                                start: date,
                                display: 'background',
                                extendedProps: {
                                    weatherIcon: `https://openweathermap.org/img/wn/${weatherIcon}.png`,
                                    weatherTemp: temperature
                                }
                            };

                            events.push(event);
                        }
                    });

                    console.log('Events with Weather:', events); // 콘솔 로그로 이벤트 확인
                    initializeFullCalendar(events);
                })
                .catch(error => console.error(`API 요청 중 에러 발생 (${cityName}):`, error));
        }

        function fetchData(){
            $.ajax({
                url: '/calendar',
                type: 'POST',
                data: {
                    memberId: userId // memberId를 데이터로 전달
                },
                success: function(response) {
                    console.log(response);
                    var confirms = response.confirm || [];
                    var applies = response.apply || [];
                    console.log('-----'+applies);
                       console.log('-----'+confirms);
                    // 서버에서 받은 데이터를 이벤트 객체로 변환하여 배열에 추가
                    confirms.forEach(res => {
                        events.push({
                            title: res.title,
                            color: "#0000FF",
                            textColor: "#000000",
                            start: res.date,
                        });
                    });
                    applies.forEach(res => {
                        events.push({
                            title: res.title,
                            color: "#FF6666",
                            textColor: "#000000",
                            start: res.date
                        });
                    });

                    console.log('Events:', events); // 콘솔 로그로 이벤트 확인
                    fetchWeather(city.engName, city.korName);
                },
                error: function() {
                    console.log('Failed to fetch data from the server.');
                }
            });
        }
    });
</script>
</body>
</html>
